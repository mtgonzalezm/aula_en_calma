<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aula en Calma – Modo Local</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .student-card { transition: all 0.2s ease-in-out; }
    .student-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .status-btn.active { transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    #modal.hidden, #main-app-screen.hidden, #loading-spinner.hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

<!-- Pantalla de Selección -->
<div id="selection-screen" class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
    <div class="flex items-center justify-center mb-6">
      <i class="fas fa-school text-4xl text-blue-500"></i>
      <h1 class="text-3xl font-bold text-gray-800 dark:text-white ml-3">Aula en Calma</h1>
    </div>
    <div class="space-y-4">
      <div>
        <label for="teacher-selector" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Profesor/a</label>
        <select id="teacher-selector" class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white">
          <option>Ana García (Tutora)</option>
          <option>Carlos Pérez (Matemáticas)</option>
          <option>Laura Martínez (Música)</option>
        </select>
      </div>
      <div>
        <label for="class-selector" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Clase</label>
        <select id="class-selector" class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white">
          <option>2º ESO A</option>
          <option>2º ESO B</option>
          <option>3º ESO C</option>
        </select>
      </div>
      <div>
        <label for="subject-selector" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Asignatura</label>
        <select id="subject-selector" class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white">
          <option>Tutoría</option>
          <option>Matemáticas</option>
          <option>Música</option>
          <option>Lengua Castellana</option>
          <option>Educación Física</option>
        </select>
      </div>
    </div>
    <div class="mt-8">
      <button id="start-session-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition-transform hover:scale-105">
        Comenzar Registro
      </button>
    </div>
  </div>
</div>

<!-- Pantalla Principal -->
<div id="main-app-screen" class="hidden flex-col min-h-screen">
  <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center">
    <div class="flex items-center space-x-3">
      <i class="fas fa-school text-2xl text-blue-500"></i>
      <h1 class="text-xl font-bold text-gray-800 dark:text-white">Aula en Calma</h1>
    </div>
    <div class="text-right">
      <div id="session-info" class="text-sm font-semibold text-gray-700 dark:text-gray-200"></div>
      <span id="current-date" class="text-xs text-gray-500 dark:text-gray-400"></span>
    </div>
  </header>

  <main class="flex-grow container mx-auto p-4">
    <div id="student-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
  </main>

  <footer class="bg-white dark:bg-gray-800 shadow-t-md p-4 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 sticky bottom-0">
    <button id="calm-strategies-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg"><i class="fas fa-leaf mr-2"></i>Estrategias</button>
    <button id="generate-report-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg"><i class="fas fa-chart-line mr-2"></i>Informe</button>
    <button id="export-csv-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg"><i class="fas fa-file-csv mr-2"></i>Exportar CSV</button>
  </footer>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 max-w-4xl w-full">
    <div class="flex justify-between items-center mb-4">
      <h2 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-white"></h2>
      <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button>
    </div>
    <div id="modal-content" class="text-gray-700 dark:text-gray-300 max-h-[70vh] overflow-y-auto"></div>
  </div>
</div>

<script>
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modal-title');
  const modalContent = document.getElementById('modal-content');
  const modalCloseBtn = document.getElementById('modal-close-btn');
  modalCloseBtn.onclick = () => modal.classList.add('hidden');

  const showModal = (title, content) => {
    modalTitle.textContent = title;
    modalContent.innerHTML = content;
    modal.classList.remove('hidden');
  };

  const saveToLocal = () => localStorage.setItem('aulaEnCalmaData', JSON.stringify(dailyData));
  const loadFromLocal = () => JSON.parse(localStorage.getItem('aulaEnCalmaData') || '{}');

  let sessionData = {};
  let dailyData = loadFromLocal();

  document.getElementById('start-session-btn').addEventListener('click', () => {
    sessionData = {
      teacher: document.getElementById('teacher-selector').value,
      class: document.getElementById('class-selector').value,
      subject: document.getElementById('subject-selector').value
    };
    document.getElementById('selection-screen').classList.add('hidden');
    document.getElementById('main-app-screen').classList.remove('hidden');
    initializeAppUI();
  });

  function initializeAppUI() {
    document.getElementById('session-info').textContent =
      `${sessionData.class} - ${sessionData.subject} (${sessionData.teacher})`;
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-ES', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    if (!dailyData.students) {
      dailyData.students = Array.from({ length: 25 }, (_, i) => ({
        id: `A${i+1}`, name: `Alumno ${i+1}`, subjects: {}
      }));
    }
    renderStudentCards();
  }

  function renderStudentCards() {
    const grid = document.getElementById('student-grid');
    grid.innerHTML = '';
    dailyData.students.forEach((s, index) => {
      const subjectKey = sessionData.subject;
      if (!s.subjects[subjectKey]) s.subjects[subjectKey] = { attendance:null, behavior:0, mood:null, reports:0, bathroom:0 };
      const d = s.subjects[subjectKey];
      const card = document.createElement('div');
      card.className = 'student-card bg-white dark:bg-gray-800 rounded-lg shadow p-4';
      card.innerHTML = `
        <div class="flex justify-between"><span class="font-bold">${s.name}</span><span class="text-xs">ID:${s.id}</span></div>
        <p class="text-sm text-gray-500 mt-2">Asistencia</p>
        <div class="flex justify-around">
          <button data-i="${index}" data-a="attendance" data-v="present" class="status-btn text-green-500 text-xl"><i class="fas fa-check-circle"></i></button>
          <button data-i="${index}" data-a="attendance" data-v="absent" class="status-btn text-red-500 text-xl"><i class="fas fa-times-circle"></i></button>
          <button data-i="${index}" data-a="attendance" data-v="late" class="status-btn text-yellow-500 text-xl"><i class="fas fa-clock"></i></button>
        </div>
        <p class="text-sm text-gray-500 mt-2">Comportamiento</p>
        <div class="flex justify-around items-center">
          <button data-i="${index}" data-a="behavior" data-v="positive" class="text-blue-500 text-xl"><i class="fas fa-plus-circle"></i></button>
          <span class="behavior font-bold">${d.behavior}</span>
          <button data-i="${index}" data-a="behavior" data-v="negative" class="text-orange-500 text-xl"><i class="fas fa-minus-circle"></i></button>
        </div>
        <p class="text-sm text-gray-500 mt-2">Clima Emocional</p>
        <div class="flex justify-around">
          <button data-i="${index}" data-a="mood" data-v="happy" class="text-yellow-400 text-xl"><i class="fas fa-smile"></i></button>
          <button data-i="${index}" data-a="mood" data-v="neutral" class="text-gray-400 text-xl"><i class="fas fa-meh"></i></button>
          <button data-i="${index}" data-a="mood" data-v="sad" class="text-blue-400 text-xl"><i class="fas fa-frown"></i></button>
        </div>`;
      grid.appendChild(card);
    });
  }

  document.getElementById('student-grid').addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const i = btn.dataset.i;
    const a = btn.dataset.a;
    const v = btn.dataset.v;
    const s = dailyData.students[i];
    const subj = sessionData.subject;
    const d = s.subjects[subj];
    switch (a) {
      case 'attendance': d.attendance = v; break;
      case 'behavior': d.behavior += v==='positive'?1:-1; break;
      case 'mood': d.mood = v; break;
    }
    saveToLocal();
    renderStudentCards();
  });

  document.getElementById('generate-report-btn').onclick = () => {
    let html = `<p>Informe diario de ${sessionData.class}</p>`;
    dailyData.students.forEach(s=>{
      html += `<div class='mt-2'><strong>${s.name}</strong> (${s.id})<ul>`;
      Object.entries(s.subjects).forEach(([k,v])=>{
        html += `<li>${k}: Asist. ${v.attendance||'N/R'} | Comp. ${v.behavior} | Estado ${v.mood||'N/R'}</li>`;
      });
      html += '</ul></div>';
    });
    showModal('Informe Diario', html);
  };

  document.getElementById('calm-strategies-btn').onclick = ()=>{
    showModal('Estrategias Calmantes', `
      <ul class="space-y-2">
        <li><strong>Respiración cuadrada:</strong> Inhala 4s, mantén 4s, exhala 4s, pausa 4s.</li>
        <li><strong>Técnica 5-4-3-2-1:</strong> 5 cosas que ves, 4 que tocas, 3 que oyes, 2 que hueles, 1 que saboreas.</li>
        <li><strong>Pausa activa:</strong> Estiramientos suaves y respiración lenta.</li>
      </ul>`);
  };

  document.getElementById('export-csv-btn').onclick = ()=>{
    let csv = 'ID,Nombre,Asignatura,Asistencia,Comportamiento,Clima\n';
    dailyData.students.forEach(s=>{
      Object.entries(s.subjects).forEach(([k,v])=>{
        csv += `${s.id},${s.name},${k},${v.attendance||''},${v.behavior},${v.mood||''}\n`;
      });
    });
    const blob = new Blob([csv],{type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'informe_aula_en_calma.csv';
    a.click();
  };
</script>

</body>
</html>
